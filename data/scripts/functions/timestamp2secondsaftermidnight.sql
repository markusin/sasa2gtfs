DROP TABLE TMP_MAX_DATE_STR;
CREATE TABLE TMP_MAX_DATE_STR AS SELECT TO_CHAR(MIN(DEPARTURE_TIME),'YYYY-MM-DD') AS MAX_DATE_STR FROM @TABLE_NAME@;
CREATE OR REPLACE
FUNCTION  TIMESTAMP2SECONDSAFTERMDN(P_TIME TIMESTAMP,DATE_PATTERN VARCHAR2) RETURN NUMBER
IS
  MAX_TIME TIMESTAMP;
  DATE_STRING VARCHAR2(10);
BEGIN
   SELECT MAX_DATE_STR INTO DATE_STRING FROM TMP_MAX_DATE_STR WHERE ROWNUM=1; 
   MAX_TIME := TO_TIMESTAMP(CONCAT(DATE_STRING,'-23:59:59'),CONCAT(DATE_PATTERN,'-HH24:MI:SS'));
   IF P_TIME IS NULL
   THEN RETURN NULL;
   END IF;

   IF  P_TIME < MAX_TIME
   THEN
     RETURN TO_NUMBER(TO_CHAR(P_TIME,'SSSSS'));
   ELSE
     RETURN TO_NUMBER(TO_CHAR(P_TIME,'SSSSS') + 86399);
   END IF;
END;
/
QUIT
