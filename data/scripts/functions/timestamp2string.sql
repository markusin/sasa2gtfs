DROP TABLE TMP_MAX_DATE_STR;
CREATE TABLE TMP_MAX_DATE_STR AS SELECT TO_CHAR(MIN(DEPARTURE_TIME),'YYYY-MM-DD') AS MAX_DATE_STR FROM @TABLE_NAME@;
CREATE OR REPLACE
FUNCTION  TIMESTAMP2STRING(P_TIME TIMESTAMP,DATE_PATTERN VARCHAR2) RETURN VARCHAR2
IS
  MAX_TIME TIMESTAMP;
   DATE_STRING VARCHAR2(10);
   TIME_STRING  VARCHAR2(10);
   HOUR_STRING  VARCHAR2(10);
BEGIN
   SELECT MAX_DATE_STR INTO DATE_STRING FROM TMP_MAX_DATE_STR WHERE ROWNUM=1; 
   MAX_TIME := TO_TIMESTAMP(CONCAT(DATE_STRING,'-23:59:59'),CONCAT(DATE_PATTERN,'-HH24:MI:SS'));
   IF P_TIME IS NULL
   THEN RETURN NULL;
   END IF;

   IF  P_TIME < MAX_TIME
   THEN
     TIME_STRING :=  TO_CHAR(P_TIME,'HH24:MI:SS');
   ELSE
     HOUR_STRING := 24 + TO_NUMBER(TO_CHAR(P_TIME,'HH24'));
     TIME_STRING := CONCAT(HOUR_STRING,CONCAT(':',TO_CHAR(P_TIME,'MI:SS')));
   END IF;
   RETURN  TIME_STRING;
END;
/
QUIT



