DROP TABLE @SCHEDULE_TABLE@;
CREATE TABLE @SCHEDULE_TABLE@ AS (
  SELECT 
    T.TRIP_ID, T.ROUTE_ID, 
    S1.STOP_ID AS SOURCE,
    TIMESTAMP2SECONDSAFTERMDN(S1.DEPARTURE_TIME,'YYYY-MM-DD') AS TIME_D, 
    S1.DEPARTURE_TIME,
    S2.STOP_ID AS TARGET,
    TIMESTAMP2SECONDSAFTERMDN(S2.ARRIVAL_TIME,'YYYY-MM-DD') AS TIME_A, 
    S2.ARRIVAL_TIME,
    C.SERVICE_ID
  FROM 
  @STOPTIMES_TABLE@ S1,
  @STOPTIMES_TABLE@ S2,
  @LINK_TABLE@ E,
  @TRIP_TABLE@ T,
  @CALENDAR_TABLE@ C
  WHERE 
    -- SAME TRIP
    S1.TRIP_ID=S2.TRIP_ID 
    -- AVOID SELF CONNECTION
    AND S1.STOP_ID<>S2.STOP_ID
    AND S1.STOP_ID=E.SOURCE
    AND S2.STOP_ID=E.TARGET
    AND E.EDGE_MODE = 1
    AND E.ROUTE_ID = T.ROUTE_ID
    AND S1.TRIP_ID = T.TRIP_ID
    AND C.SERVICE_ID = T.SERVICE_ID
    AND S2.ARRIVAL_TIME IS NOT NULL
    AND S1.DEPARTURE_TIME IS NOT NULL
    AND S1.STOP_SEQUENCE < S2.STOP_SEQUENCE
);
CREATE INDEX @SCHEDULE_TABLE@_CMB1 ON @SCHEDULE_TABLE@(ROUTE_ID, SOURCE, TARGET);
CREATE INDEX @SCHEDULE_TABLE@_CMB2 ON @SCHEDULE_TABLE@(ROUTE_ID, SOURCE, TARGET, TIME_D, TIME_A, SERVICE_ID);
CREATE INDEX @SCHEDULE_TABLE@_CMB3 ON @SCHEDULE_TABLE@(ROUTE_ID, SOURCE, TARGET, TIME_A, TIME_D, SERVICE_ID);
QUIT