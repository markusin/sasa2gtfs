-- temporary remove later
DROP INDEX IDX1_@EDGE_TABLE@;
CREATE INDEX IDX1_@EDGE_TABLE@ ON @EDGE_TABLE@(SOURCE);
DROP INDEX IDX2_@EDGE_TABLE@;
CREATE INDEX IDX2_@EDGE_TABLE@ ON @EDGE_TABLE@(TARGET);
DROP INDEX IDX3_@EDGE_TABLE@;
CREATE BITMAP INDEX IDX3_@EDGE_TABLE@ ON @EDGE_TABLE@(EDGE_MODE);
DROP INDEX IDX4_@EDGE_TABLE@;
CREATE INDEX IDX4_@EDGE_TABLE@ ON @EDGE_TABLE@(SOURCE,EDGE_MODE);

DROP TABLE @NODE_TABLE@;
CREATE TABLE @NODE_TABLE@ AS 
  SELECT SOURCE ID, SDO_LRS.GEOM_SEGMENT_START_PT(GEOMETRY) GEOMETRY FROM @EDGE_TABLE@ WHERE EDGE_MODE=0
    UNION ALL
  SELECT TARGET ID, SDO_LRS.GEOM_SEGMENT_END_PT(GEOMETRY) GEOMETRY FROM @EDGE_TABLE@ WHERE EDGE_MODE=0;

-- deleting duplicates 
DELETE FROM @NODE_TABLE@ WHERE rowid IN(
  SELECT rowid 
  FROM ( 
  	SELECT N.ID,N.GEOMETRY, Row_Number() Over (Partition BY N.ID ORDER BY Rowid) RN FROM @NODE_TABLE@ N) 
  WHERE RN > 1
);

ALTER TABLE @NODE_TABLE@ ADD PRIMARY KEY(ID);
ALTER TABLE @NODE_TABLE@ ADD (OUTDEGREE NUMBER(4,0), C_OUTDEGREE NUMBER(3,0),"mode" NUMBER(2,0));

ALTER TABLE @NODE_TABLE@ ADD (INDEGREE NUMBER(4,0), C_INDEGREE NUMBER(3,0));

-- important check indexes

UPDATE @NODE_TABLE@ N SET N.C_OUTDEGREE=(
	SELECT COUNT(L.ID) FROM @EDGE_TABLE@ L 
	WHERE N.ID=L.SOURCE AND L.EDGE_MODE=0 
	GROUP BY N.ID
);

UPDATE @NODE_TABLE@ N SET N.OUTDEGREE=(
	SELECT COUNT(L.ID) FROM @EDGE_TABLE@ L 
	WHERE N.ID=L.SOURCE 
	GROUP BY N.ID
);

UPDATE @NODE_TABLE@ N SET N.C_INDEGREE=(
	SELECT COUNT(L.ID) FROM @EDGE_TABLE@ L 
	WHERE N.ID=L.TARGET AND L.EDGE_MODE=0 
	GROUP BY N.ID
);

UPDATE @NODE_TABLE@ N SET N.INDEGREE=(
	SELECT COUNT(L.ID) FROM @EDGE_TABLE@ L 
	WHERE N.ID=L.TARGET 
	GROUP BY N.ID
);

UPDATE @NODE_TABLE@ N SET N."mode"=1
WHERE N.ID IN (
	SELECT SOURCE FROM @EDGE_TABLE@ WHERE EDGE_MODE=1 UNION SELECT TARGET FROM @EDGE_TABLE@ WHERE EDGE_MODE=1
);

UPDATE @NODE_TABLE@ N SET N."mode"=0 WHERE N."mode" IS NULL;

-- updating the geometry
UPDATE @NODE_TABLE@ SET GEOMETRY=SDO_LRS.CONVERT_TO_STD_GEOM(SDO_LRS.CONVERT_TO_LRS_GEOM(GEOMETRY)) WHERE GEOMETRY IS NOT NULL;
COMMIT;
QUIT
